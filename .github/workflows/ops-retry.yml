name: 'Retry Workflow'
on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'The ID of the workflow run to retry'
        required: true
jobs:
  rerun:
    runs-on: ubuntu-latest
    steps:
      - name: Watch the original workflow run
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
        run: |
          echo "Watching run ${{ inputs.run_id }} to complete..."
          gh run watch ${{ inputs.run_id }} > /dev/null 2>&1
      - name: Rerun failed jobs
        id: rerun
        continue-on-error: true
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
        run: |
          echo "Rerunning failed jobs for ${{ inputs.run_id }}..."
          gh run rerun ${{ inputs.run_id }} --failed
      - name: Fetch Access Token (for Microsoft Graph)
        if: steps.rerun.outcome == 'failure'
        run: |
          TOKEN_RESPONSE=$(curl -X POST 'https://login.microsoftonline.com/c9b9cb50-3644-4db4-a267-fa84df2f4ceb/oauth2/v2.0/token' \
          --header 'Content-Type: application/x-www-form-urlencoded' \
          --data-urlencode 'client_id=${{ secrets.CLIENT_ID }}' \
          --data-urlencode 'client_secret=${{ secrets.CLIENT_SECRET }}' \
          --data-urlencode 'scope=https://graph.microsoft.com/.default' \
          --data-urlencode 'grant_type=client_credentials')
          echo "TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')" >> $GITHUB_ENV
      - name: Notify Failure via Email
        if: steps.rerun.outcome == 'failure'
        run: |
          SUBJECT="‚ùå Compliance Retry Failed"
          BODY="<p>The retry workflow run ${{ inputs.run_id }} for <strong>${{ github.repository }}</strong> has failed.</p>"

          curl --location 'https://graph.microsoft.com/v1.0/users/noreply.kente@mtn.com/sendMail' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer $TOKEN" \
            --data-raw '{
              "message": {
                "subject": "'"$SUBJECT"'",
                "body": {
                  "contentType": "HTML",
                  "content": "'"$BODY"'"
                },
                "toRecipients": [
                  { "emailAddress": { "address": "kim.smart@mtn.com" } }
                ]
              }
            }'
